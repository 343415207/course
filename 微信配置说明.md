# 微信小程序配置说明

## ✅ 配置已更新

### 当前配置

- **AppID**: `wx8e19d3353e5bdbb4`
- **Secret**: `9d3adfab681034bafa103cf4417235d8`

配置已更新到 `.env` 文件，服务已重启。

## 🔄 登录模式

现在有两种登录模式：

### 1. 真实微信登录（已配置）

当配置了真实的 AppID 和 Secret 时：
- 调用微信 API 获取真实的 openid
- 用户通过微信授权登录
- 适用于生产环境

### 2. 测试登录模式（开发环境备用）

如果检测到开发环境且配置未设置，会使用测试模式：
- 使用预设的测试 openid
- 无需真实微信配置即可测试

## 🧪 测试登录

### 现在可以测试真实微信登录

1. **在小程序中点击"我的" → "立即登录"**
2. **进行微信授权**
3. **登录成功后**：
   - 会获取真实的 openid
   - 创建或更新用户信息
   - 返回 JWT Token

### 查看登录日志

```bash
docker-compose logs -f api
```

登录时会看到：
- 调用微信 API 的请求
- 获取到的 openid
- 用户创建/更新信息

## 📝 注意事项

### 1. 微信开发者工具设置

确保在微信开发者工具中：
- 项目设置 → 本地设置
- ✅ 勾选"不校验合法域名"

### 2. AppID 匹配

确保微信开发者工具中使用的 AppID 与配置的 AppID 一致：
- 当前配置: `wx8e19d3353e5bdbb4`
- 在 `project.config.json` 中检查 AppID

### 3. 服务器域名配置（生产环境）

生产环境需要在微信公众平台配置：
- 开发 → 开发管理 → 开发设置 → 服务器域名
- 添加 request 合法域名
- 添加 uploadFile 合法域名

## 🔍 验证配置

### 检查配置是否正确

```bash
# 查看 .env 文件中的配置
cat .env | grep WX_
```

应该显示：
```
WX_APPID=wx8e19d3353e5bdbb4
WX_SECRET=9d3adfab681034bafa103cf4417235d8
```

### 测试登录

1. 在小程序中尝试登录
2. 查看后端日志确认是否调用微信 API
3. 检查是否成功获取 openid

## 🐛 故障排查

### 问题1：仍然使用测试模式

**原因**: 配置未正确加载

**解决**:
1. 确认 `.env` 文件配置正确
2. 重启服务: `docker-compose restart api`
3. 查看日志确认配置已加载

### 问题2：微信 API 调用失败

**可能原因**:
- AppID 或 Secret 错误
- 网络问题
- 微信服务器问题

**解决**:
1. 检查 AppID 和 Secret 是否正确
2. 查看后端日志中的错误信息
3. 确认网络连接正常

### 问题3：获取 openid 失败

**可能原因**:
- code 已过期（code 只能使用一次）
- AppID 和 Secret 不匹配

**解决**:
1. 重新获取 code（重新点击登录）
2. 检查 AppID 和 Secret 是否匹配

## 📊 当前状态

- ✅ 微信 AppID 已配置
- ✅ 微信 Secret 已配置
- ✅ 服务已重启
- ✅ 可以使用真实微信登录

现在可以在小程序中测试真实的微信登录了！

