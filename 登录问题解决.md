# 登录问题解决方案

## 🔍 问题分析

登录失败的原因通常是：

1. **微信配置未设置**（最常见）
   - `.env` 文件中的 `WX_APPID` 和 `WX_SECRET` 是占位符
   - 导致无法调用微信API获取 openid

2. **网络问题**
   - 无法访问微信API
   - 防火墙或代理问题

3. **用户授权问题**
   - 用户拒绝授权
   - `getUserProfile` 被拒绝

## ✅ 已修复：开发环境测试登录

我已经添加了**开发环境测试登录模式**，即使没有配置真实的微信 AppID 和 Secret，也可以正常登录测试。

### 测试登录模式

当检测到开发环境且微信配置未设置时，会自动使用测试模式：
- 使用预设的测试 openid
- 可以测试不同的用户
- 无需真实的微信配置

### 测试用户

测试模式会使用以下 openid（按 code 的哈希值选择）：
- `test_user_openid` - 测试用户（有课程和记录）
- `test_admin_openid` - 管理员
- `user_001` ~ `user_008` - 其他测试用户

## 🧪 测试步骤

### 1. 重启服务（已完成）

服务已自动重启，新的登录逻辑已生效。

### 2. 在小程序中测试

1. **打开小程序**
2. **点击"我的" tab**
3. **点击"立即登录"**
4. **进行微信授权**（即使配置未设置，也会使用测试模式）
5. **登录成功后**，返回首页查看课程列表

### 3. 查看登录结果

登录成功后：
- 首页应该显示课程列表
- "我的"页面显示用户信息
- 可以正常使用所有功能

## 🔧 配置真实微信（可选）

如果需要使用真实的微信登录：

### 1. 获取微信小程序 AppID 和 Secret

1. 访问：https://mp.weixin.qq.com
2. 登录微信公众平台
3. 进入"开发" → "开发管理" → "开发设置"
4. 获取 AppID 和 AppSecret

### 2. 更新 `.env` 文件

```bash
# 编辑 .env 文件
WX_APPID=你的真实AppID
WX_SECRET=你的真实AppSecret
```

### 3. 重启服务

```bash
docker-compose restart api
```

## 📝 登录流程说明

### 开发环境（测试模式）

```
小程序 → 获取 code → 后端
    ↓
检测到开发环境 + 微信配置未设置
    ↓
使用测试 openid（test_user_openid 等）
    ↓
查找或创建用户 → 生成 Token → 返回
```

### 生产环境（真实微信）

```
小程序 → 获取 code → 后端
    ↓
调用微信API (jscode2session)
    ↓
获取真实 openid
    ↓
查找或创建用户 → 生成 Token → 返回
```

## 🐛 故障排查

### 问题1：仍然提示登录失败

**检查**:
1. 查看小程序 Console 面板的错误信息
2. 查看后端日志: `docker-compose logs api`
3. 确认服务已重启

### 问题2：用户授权被拒绝

**解决**:
- 在微信开发者工具中，点击"清缓存" → "清除授权数据"
- 重新尝试登录

### 问题3：网络请求失败

**检查**:
1. 确认勾选了"不校验合法域名"
2. 确认 API 地址正确: `http://localhost:9000/api`
3. 测试服务: `curl http://localhost:9000/health`

## 📊 当前状态

- ✅ 开发环境测试登录已启用
- ✅ 服务已重启
- ✅ 可以使用测试用户登录

## 🎯 下一步

1. **在小程序中测试登录**
   - 应该可以成功登录
   - 登录后可以看到课程列表

2. **测试功能**
   - 查看课程详情
   - 创建记录
   - 上传图片

3. **（可选）配置真实微信**
   - 获取 AppID 和 Secret
   - 更新 `.env` 文件
   - 重启服务

现在可以重新尝试登录了！如果还有问题，请查看小程序 Console 面板的具体错误信息。

