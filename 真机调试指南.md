# 微信小程序真机调试指南

## 前置条件

1. **后端服务需要可访问**
   - 真机无法访问 `localhost`，需要使用局域网 IP 或公网地址
   - 确保手机和电脑在同一局域网内

2. **微信开发者工具设置**
   - 打开"设置" → "安全" → 开启"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

## 步骤一：获取电脑的局域网 IP

### macOS/Linux
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

### Windows
```cmd
ipconfig
```
查找 "IPv4 地址"，例如：`192.168.1.100`

## 步骤二：修改小程序 API 地址

### 方法1：修改 app.js（推荐用于开发）

打开 `miniprogram/app.js`，修改 `apiBaseUrl`：

```javascript
globalData: {
  userInfo: null,
  token: null,
  // 将 localhost 替换为你的局域网 IP
  apiBaseUrl: 'http://192.168.1.100:9000/api' // 替换为你的实际 IP
}
```

### 方法2：使用环境变量（更灵活）

可以创建不同环境的配置文件，根据环境切换 API 地址。

## 步骤三：确保后端服务可访问

### 检查 Docker 服务

```bash
# 确保后端服务正在运行
docker-compose ps

# 检查端口是否监听在 0.0.0.0（而不是 127.0.0.1）
docker-compose logs api | grep "listening"
```

### 测试 API 是否可访问

在手机浏览器或电脑浏览器中访问：
```
http://你的局域网IP:9000/api/health
```

如果返回 `{"status":"ok"}`，说明服务可访问。

## 步骤四：配置微信开发者工具

1. **打开微信开发者工具**
2. **点击"预览"按钮**（或使用快捷键 `Ctrl/Cmd + P`）
3. **生成二维码**
4. **用微信扫码**（需要使用开发者的微信账号）

## 步骤五：真机调试

### 方式1：预览模式（推荐）

1. 在微信开发者工具中点击"预览"
2. 用微信扫码
3. 在手机上打开小程序
4. 查看控制台日志（在开发者工具的"调试器"中）

### 方式2：真机调试模式

1. 在微信开发者工具中点击"真机调试"
2. 用微信扫码
3. 在手机上打开小程序
4. 可以在开发者工具中实时查看：
   - 控制台日志
   - 网络请求
   - 性能数据

## 常见问题

### 1. 无法连接后端服务

**问题**：真机上显示"网络错误"或"请求失败"

**解决方案**：
- 检查手机和电脑是否在同一 WiFi 网络
- 检查防火墙是否阻止了 9000 端口
- 检查后端服务是否监听在 `0.0.0.0:9000`（而不是 `127.0.0.1:9000`）

**检查 Docker 配置**：
```yaml
# docker-compose.yml 中确保端口映射正确
ports:
  - "9000:3000"  # 应该监听所有网络接口
```

### 2. HTTPS 证书问题

**问题**：真机上显示"不在以下 request 合法域名列表中"

**解决方案**：
- 在微信开发者工具中：设置 → 项目设置 → 本地设置 → 勾选"不校验合法域名..."
- 或者配置合法域名（需要 HTTPS）

### 3. IP 地址变化

**问题**：每次重启路由器后 IP 地址可能变化

**解决方案**：
- 在路由器中为电脑设置静态 IP
- 或者使用动态域名服务（DDNS）
- 或者每次修改 `app.js` 中的 IP 地址

### 4. 端口被占用

**问题**：9000 端口无法访问

**解决方案**：
```bash
# 检查端口占用
lsof -i :9000  # macOS/Linux
netstat -ano | findstr :9000  # Windows

# 如果被占用，可以修改 docker-compose.yml 中的端口映射
ports:
  - "9001:3000"  # 改为其他端口
```

## 生产环境配置

### 使用 HTTPS 和域名

1. **申请域名和 SSL 证书**
2. **配置 Nginx 反向代理**
3. **在微信公众平台配置合法域名**
4. **修改 app.js 中的 apiBaseUrl**：
   ```javascript
   apiBaseUrl: 'https://your-domain.com/api'
   ```

## 调试技巧

### 1. 查看网络请求

在真机调试模式下，可以在开发者工具的"Network"面板查看所有网络请求。

### 2. 查看控制台日志

- 在开发者工具的"Console"面板查看日志
- 使用 `console.log()` 输出调试信息

### 3. 使用 vConsole

可以在小程序中集成 vConsole 来在手机上直接查看控制台：
```javascript
// 在 app.js 中
if (process.env.NODE_ENV === 'development') {
  const vConsole = require('./utils/vconsole.min.js');
}
```

### 4. 查看存储数据

在开发者工具的"Storage"面板查看本地存储的数据。

## 快速检查清单

- [ ] 获取电脑局域网 IP
- [ ] 修改 `app.js` 中的 `apiBaseUrl`
- [ ] 确保 Docker 服务运行正常
- [ ] 测试 API 在浏览器中可访问
- [ ] 在微信开发者工具中开启"不校验合法域名"
- [ ] 使用预览或真机调试功能
- [ ] 检查网络请求是否成功

## 参考链接

- [微信小程序真机调试文档](https://developers.weixin.qq.com/miniprogram/dev/devtools/remote-debug.html)
- [微信小程序网络请求文档](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

