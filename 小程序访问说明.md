# 小程序访问 Docker 服务说明

## ✅ 是的，小程序访问的是本地 Docker 服务

### 当前配置

**小程序 API 地址**（`miniprogram/app.js`）:
```javascript
apiBaseUrl: 'http://localhost:9000/api'
```

**Docker 服务端口映射**:
- 容器内部端口: `3000`
- 主机映射端口: `9000`
- 访问地址: `http://localhost:9000`

所以小程序通过 `http://localhost:9000/api` 访问的就是运行在 Docker 中的后端服务。

## 🔍 访问流程

```
微信开发者工具
    ↓
http://localhost:9000/api
    ↓
Docker 端口映射 (9000 → 3000)
    ↓
course_api 容器
    ↓
Express 应用 (端口 3000)
```

## ⚙️ 开发环境设置

### 必须设置（重要！）

在微信开发者工具中：

1. 点击右上角 **"详情"** 或 **"设置"**
2. 选择 **"项目设置"** → **"本地设置"**
3. **勾选**：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

**如果不勾选这个选项，小程序无法访问 localhost！**

## 📱 不同场景的访问方式

### 1. 微信开发者工具（模拟器）

✅ **可以使用 `localhost`**
- 配置: `http://localhost:9000/api`
- 需要勾选"不校验合法域名"

### 2. 真机调试

❌ **不能使用 `localhost`**
- `localhost` 在真机上指向手机本身，不是你的电脑
- 需要使用局域网 IP

**解决方法**:

1. **获取电脑的局域网 IP**:
   ```bash
   # Mac/Linux
   ifconfig | grep "inet " | grep -v 127.0.0.1
   
   # Windows
   ipconfig
   ```
   找到类似 `192.168.1.100` 的 IP

2. **修改 `miniprogram/app.js`**:
   ```javascript
   apiBaseUrl: 'http://192.168.1.100:9000/api' // 改为你的局域网IP
   ```

3. **确保手机和电脑在同一 WiFi 网络**

### 3. 生产环境

❌ **不能使用 `localhost`**
- 需要配置实际的服务器域名
- 必须是 HTTPS
- 需要在微信公众平台配置合法域名

## 🧪 测试连接

### 在微信开发者工具中测试

1. **打开 Console 面板**（调试器 → Console）
2. **查看网络请求**（调试器 → Network）
3. **测试 API 调用**:
   - 打开小程序
   - 查看 Console 是否有错误
   - 查看 Network 中的请求是否成功

### 使用浏览器测试（验证服务）

在浏览器中访问：
- http://localhost:9000/health
- http://localhost:9000/api/banners

如果浏览器能访问，说明服务正常，小程序也应该能访问（前提是勾选了"不校验合法域名"）。

## 🔧 常见问题

### 问题1：网络请求失败

**错误**: `request:fail` 或 `errno: 600008`

**原因**: 
- 未勾选"不校验合法域名"
- Docker 服务未启动
- API 地址配置错误

**解决**:
1. 确认勾选了"不校验合法域名"
2. 检查服务状态: `docker-compose ps`
3. 检查 API 地址: `app.js` 中的 `apiBaseUrl`

### 问题2：真机调试无法连接

**原因**: 真机上 `localhost` 指向手机本身

**解决**: 使用局域网 IP，参考上面的"真机调试"部分

### 问题3：服务无法访问

**检查步骤**:
```bash
# 1. 检查服务是否运行
docker-compose ps

# 2. 检查端口是否被占用
lsof -i :9000

# 3. 测试服务
curl http://localhost:9000/health

# 4. 查看服务日志
docker-compose logs api
```

## 📊 当前服务状态

运行以下命令查看服务状态：

```bash
docker-compose ps
```

应该看到：
- `course_api` - 运行中，端口 `0.0.0.0:9000->3000/tcp`
- `course_mysql` - 运行中
- `course_phpmyadmin` - 运行中

## ✅ 验证清单

在开始测试前，确认：

- [ ] Docker 服务已启动 (`docker-compose ps` 显示运行中)
- [ ] API 健康检查通过 (`curl http://localhost:9000/health`)
- [ ] 小程序中已勾选"不校验合法域名"
- [ ] `app.js` 中的 `apiBaseUrl` 配置正确
- [ ] 微信开发者工具已打开项目

## 🎯 快速验证

1. **在浏览器测试**:
   ```bash
   curl http://localhost:9000/api/banners
   ```
   应该返回 Banner 列表

2. **在小程序测试**:
   - 打开小程序
   - 查看首页是否显示 Banner
   - 查看 Console 是否有错误

如果浏览器能访问但小程序不能，通常是"不校验合法域名"未勾选。

