# 微信小程序开发计划

> ⚠️ **注意**: 本文档已拆分为多个详细文档，请查看 `docs/` 目录。
> 
> - 📖 [文档索引](./docs/README.md)
> - 📋 [项目概述](./docs/overview.md)
> - 📚 [详细文档](./docs/)

---

# 微信小程序开发计划（原始文档）

## 项目概述
开发一个课程记录管理小程序，支持用户登录、课程管理和学习记录追踪。

## 技术栈
- **前端框架**: 微信小程序原生框架
- **后端**: Node.js + Express
- **数据库**: MySQL + Sequelize ORM
- **数据库管理**: phpMyAdmin
- **容器化**: Docker + Docker Compose
- **存储**: 腾讯云COS（用于图片上传）
- **认证**: JWT 身份认证
- **HTTP客户端**: Axios

## 功能模块

### 1. 用户认证模块
- **微信授权登录**
  - 获取用户微信信息
  - 创建/更新用户记录
  - 区分管理员和普通用户角色
  - 用户信息存储到云数据库

### 2. 首页模块
- **Banner轮播图**
  - 支持多张图片轮播
  - 可配置（管理员可管理）
  
- **课程列表**
  - 卡片式双列布局
  - 显示课程名称
  - 显示最后一节课的记录时间
  - 显示总上课次数
  - 点击卡片进入课程详情

- **底部导航**
  - 首页 tab
  - 我的 tab

### 3. 课程详情模块
- **记录列表**
  - 显示该课程的所有学习记录
  - 按创建时间倒序排列（最新的在前）
  - 每条记录显示：创建时间、备注文字（如果有）、图片（如果有）
  - 点击记录进入记录详情

- **新增记录按钮**
  - 大按钮，位于列表下方
  - 点击后创建新的学习记录
  - 自动记录创建时间

### 4. 记录详情模块
- **记录信息展示**
  - 显示创建时间
  - 显示备注文字（可编辑）
  - 显示已上传的图片
  
- **备注编辑功能**
  - 支持编辑和保存备注文字
  
- **图片上传功能**
  - 支持选择图片
  - 上传到云存储
  - 更新记录信息

### 5. 我的页面模块
- **用户信息展示**
  - 显示用户头像、昵称
  - 显示用户角色（管理员/普通用户）
  
- **功能入口**
  - 退出登录
  - 管理员功能入口（如：课程管理、Banner管理等）

## 数据库设计（MySQL）

### users 表（用户表）
```sql
CREATE TABLE `users` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `openid` VARCHAR(100) UNIQUE NOT NULL COMMENT '微信openid',
  `unionid` VARCHAR(100) COMMENT '微信unionid',
  `nick_name` VARCHAR(100) COMMENT '昵称',
  `avatar_url` VARCHAR(500) COMMENT '头像URL',
  `role` ENUM('admin', 'user') DEFAULT 'user' COMMENT '角色：admin管理员，user普通用户',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_openid` (`openid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### courses 表（课程表）
```sql
CREATE TABLE `courses` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(200) NOT NULL COMMENT '课程名称',
  `user_id` INT NOT NULL COMMENT '所属用户ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_user_id` (`user_id`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='课程表';
```

### records 表（学习记录表）
```sql
CREATE TABLE `records` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `course_id` INT NOT NULL COMMENT '所属课程ID',
  `user_id` INT NOT NULL COMMENT '所属用户ID',
  `note` TEXT COMMENT '备注文字',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_course_id` (`course_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_created_at` (`created_at`),
  FOREIGN KEY (`course_id`) REFERENCES `courses`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='学习记录表';
```

### record_images 表（记录图片表）
```sql
CREATE TABLE `record_images` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `record_id` INT NOT NULL COMMENT '所属记录ID',
  `image_url` VARCHAR(500) NOT NULL COMMENT '图片URL',
  `sort` INT DEFAULT 0 COMMENT '排序',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX `idx_record_id` (`record_id`),
  FOREIGN KEY (`record_id`) REFERENCES `records`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='记录图片表';
```

### banners 表（轮播图表）
```sql
CREATE TABLE `banners` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `image_url` VARCHAR(500) NOT NULL COMMENT '图片URL',
  `link` VARCHAR(500) COMMENT '跳转链接（可选）',
  `sort` INT DEFAULT 0 COMMENT '排序',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1启用，0禁用',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX `idx_sort` (`sort`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='轮播图表';
```

## 项目结构

### 前端（微信小程序）
```
miniprogram/
  ├── pages/
  │   ├── index/              # 首页
  │   │   ├── index.js
  │   │   ├── index.wxml
  │   │   ├── index.wxss
  │   │   └── index.json
  │   ├── course-detail/      # 课程详情页
  │   │   ├── course-detail.js
  │   │   ├── course-detail.wxml
  │   │   ├── course-detail.wxss
  │   │   └── course-detail.json
  │   ├── record-detail/      # 记录详情页
  │   │   ├── record-detail.js
  │   │   ├── record-detail.wxml
  │   │   ├── record-detail.wxss
  │   │   └── record-detail.json
  │   └── profile/            # 我的页面
  │       ├── profile.js
  │       ├── profile.wxml
  │       ├── profile.wxss
  │       └── profile.json
  ├── utils/
  │   ├── api.js              # API请求封装
  │   ├── auth.js             # 认证相关
  │   └── util.js             # 工具函数
  ├── app.js
  ├── app.json
  └── app.wxss
```

### 后端（Node.js）
```
server/
  ├── config/                 # 配置文件
  │   ├── database.js         # 数据库配置
  │   └── config.js           # 应用配置
  ├── controllers/            # 控制器
  │   ├── authController.js   # 认证控制器
  │   ├── courseController.js # 课程控制器
  │   ├── recordController.js # 记录控制器
  │   └── bannerController.js # Banner控制器
  ├── models/                 # 数据模型
  │   ├── User.js
  │   ├── Course.js
  │   ├── Record.js
  │   └── Banner.js
  ├── routes/                 # 路由
  │   ├── auth.js
  │   ├── courses.js
  │   ├── records.js
  │   └── banners.js
  ├── middleware/             # 中间件
  │   ├── auth.js             # 认证中间件
  │   └── errorHandler.js     # 错误处理
  ├── utils/                  # 工具函数
  │   ├── jwt.js              # JWT工具
  │   └── upload.js           # 文件上传
  ├── uploads/                # 上传文件目录
  ├── Dockerfile              # Docker镜像构建文件
  ├── .dockerignore           # Docker忽略文件
  ├── app.js                  # 应用入口
  └── package.json
```

### Docker Compose 配置
```
docker-compose.yml            # Docker Compose配置文件
.env                          # 环境变量文件
```

## 后端 API 设计

### 认证相关
- `POST /api/auth/login` - 微信登录
  - 请求：`{ code, userInfo }`
  - 响应：`{ token, user }`

- `GET /api/auth/user` - 获取当前用户信息
  - 需要：Authorization Header (Bearer token)

### 课程相关
- `GET /api/courses` - 获取用户的课程列表（包含统计信息）
  - 响应：`[{ id, name, lastRecordTime, totalCount }, ...]`

- `GET /api/courses/:id` - 获取课程详情

- `POST /api/courses` - 创建课程（管理员）
  - 请求：`{ name, userId? }`

- `PUT /api/courses/:id` - 更新课程（管理员）

- `DELETE /api/courses/:id` - 删除课程（管理员）

### 记录相关
- `GET /api/courses/:courseId/records` - 获取课程的所有记录
  - 响应：`[{ id, courseId, note, images, createdAt }, ...]`（按创建时间倒序）

- `GET /api/records/:id` - 获取记录详情
  - 响应：`{ id, courseId, note, images, createdAt, updatedAt }`

- `POST /api/courses/:courseId/records` - 创建新记录
  - 请求：`{ note? }`（可选备注）
  - 响应：`{ id, courseId, note, createdAt }`

- `PUT /api/records/:id` - 更新记录（主要是更新备注）
  - 请求：`{ note? }`
  - 响应：`{ id, note, updatedAt }`

- `POST /api/records/:id/images` - 上传记录图片
  - 请求：FormData (file)
  - 响应：`{ imageUrl }`

- `DELETE /api/records/:id/images/:imageId` - 删除记录图片

### Banner相关
- `GET /api/banners` - 获取Banner列表
  - 响应：`[{ id, imageUrl, link, sort }, ...]`

- `POST /api/banners` - 创建Banner（管理员）
- `PUT /api/banners/:id` - 更新Banner（管理员）
- `DELETE /api/banners/:id` - 删除Banner（管理员）

## 开发步骤

### 第一阶段：后端项目初始化
1. 创建 Node.js 项目
2. 安装依赖（Express, MySQL, JWT等）
3. 配置 Docker 和 Docker Compose
   - 创建 Dockerfile
   - 创建 docker-compose.yml（包含 Node.js、MySQL、phpMyAdmin 服务）
   - 配置环境变量文件
4. 配置数据库连接
5. 创建数据库表结构
6. 配置路由和中间件
7. 实现错误处理和日志

### 第二阶段：后端认证模块
1. 实现微信登录接口（调用微信API获取openid）
2. 实现JWT Token生成和验证
3. 实现用户信息创建/更新
4. 实现认证中间件

### 第三阶段：后端业务接口
1. 实现课程相关接口
2. 实现记录相关接口（包含统计查询）
3. 实现Banner相关接口
4. 实现图片上传接口
5. 实现权限验证（用户只能操作自己的数据）

### 第四阶段：前端项目初始化
1. 创建微信小程序项目
2. 配置 app.json（页面路由、tabBar等）
3. 封装API请求工具
4. 实现Token存储和管理
5. 初始化基础样式和工具函数

### 第五阶段：前端用户认证
1. 实现微信授权登录
2. 实现Token自动刷新
3. 全局状态管理（用户信息）
4. 登录状态检查

### 第六阶段：前端首页开发
1. 实现Banner轮播图组件
2. 实现课程列表（双列卡片布局）
3. 实现底部导航栏
4. 数据获取和展示逻辑
5. 下拉刷新和上拉加载

### 第七阶段：前端课程详情页
1. 实现记录列表展示
2. 实现新增记录功能
3. 实现记录排序（按创建时间倒序）
4. 页面跳转逻辑

### 第八阶段：前端记录详情页
1. 实现记录信息展示（包含备注文字）
2. 实现备注编辑功能
3. 实现图片上传功能
4. 实现图片预览功能
5. 数据更新逻辑

### 第九阶段：前端我的页面
1. 实现用户信息展示
2. 实现退出登录功能
3. 预留管理员功能入口

### 第十阶段：优化和测试
1. 性能优化（数据库索引、查询优化）
2. 错误处理和异常捕获
3. 用户体验优化
4. 接口测试和功能测试
5. 安全性检查

## 技术选型详情

### 后端技术栈
- **框架**: Express.js
- **数据库**: MySQL 8.0+
- **ORM**: Sequelize
- **数据库管理工具**: phpMyAdmin
- **容器化**: Docker + Docker Compose
- **认证**: jsonwebtoken (JWT 身份认证)
- **文件上传**: multer + 腾讯云COS SDK (cos-nodejs-sdk-v5)
- **HTTP客户端**: Axios（用于调用微信API）
- **环境变量**: dotenv

### 前端技术栈
- **框架**: 微信小程序原生框架
- **HTTP请求**: wx.request 封装
- **状态管理**: 全局变量或简单状态管理

## 环境配置

### Docker Compose 配置
使用 Docker Compose 管理所有后端服务（Node.js、MySQL、phpMyAdmin）

**docker-compose.yml 示例配置：**
```yaml
version: '3.8'

services:
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: course_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    ports:
      - "9306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - course_network

  # phpMyAdmin 数据库管理工具
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: course_phpmyadmin
    restart: always
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
    ports:
      - "9080:80"
    depends_on:
      - mysql
    networks:
      - course_network

  # Node.js 后端服务
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: course_api
    restart: always
    ports:
      - "9000:3000"
    environment:
      - NODE_ENV=${NODE_ENV}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=${DB_NAME}
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - WX_APPID=${WX_APPID}
      - WX_SECRET=${WX_SECRET}
      - COS_SECRET_ID=${COS_SECRET_ID}
      - COS_SECRET_KEY=${COS_SECRET_KEY}
      - COS_REGION=${COS_REGION}
      - COS_BUCKET_NAME=${COS_BUCKET_NAME}
      - COS_BUCKET_URL=${COS_BUCKET_URL}
      - COS_BASE_PATH=${COS_BASE_PATH}
    volumes:
      - ./server:/app
      - /app/node_modules
    depends_on:
      - mysql
    networks:
      - course_network

volumes:
  mysql_data:

networks:
  course_network:
    driver: bridge
```

**常用 Docker Compose 命令：**
```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f api

# 重启服务
docker-compose restart api

# 进入容器
docker-compose exec api sh
```

### 数据库配置
- **MySQL**: 通过 Docker Compose 管理，容器内服务名为 `mysql`
- **phpMyAdmin**: 通过 Docker Compose 管理
  - 访问地址：`http://localhost:9080`
  - 服务器：`mysql`（容器服务名）
  - 用户名：`root`
  - 密码：从 `.env` 文件中的 `DB_PASSWORD` 获取

### 腾讯云COS配置（测试环境）
```env
COS_SECRET_ID=your_cos_secret_id
COS_SECRET_KEY=your_cos_secret_key
COS_REGION=ap-beijing
COS_BUCKET_NAME=mengu-1251481375
COS_BUCKET_URL=https://mengu-1251481375.cos.ap-beijing.myqcloud.com
COS_BASE_PATH=mengu-1251481375
```

### 后端环境变量配置（.env）
```env
# 数据库配置（Docker Compose 中使用 mysql 作为主机名）
DB_HOST=mysql
DB_PORT=3306
DB_NAME=course_db
DB_USER=root
DB_PASSWORD=your_password

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=7d

# 微信小程序配置
WX_APPID=your_wechat_appid
WX_SECRET=your_wechat_secret

# 服务器配置
PORT=3000
NODE_ENV=development

# 腾讯云COS配置
COS_SECRET_ID=your_cos_secret_id
COS_SECRET_KEY=your_cos_secret_key
COS_REGION=ap-beijing
COS_BUCKET_NAME=mengu-1251481375
COS_BUCKET_URL=https://mengu-1251481375.cos.ap-beijing.myqcloud.com
COS_BASE_PATH=mengu-1251481375
```

**注意：** 在 Docker Compose 环境中，`DB_HOST` 应设置为 `mysql`（服务名），而不是 `localhost`

## 注意事项

1. **权限控制**
   - 用户只能查看和操作自己的课程和记录
   - 管理员可以管理所有内容
   - 所有接口需要JWT Token验证
   - 敏感操作需要角色验证

2. **数据安全**
   - 使用HTTPS协议
   - JWT Token设置过期时间
   - SQL注入防护（使用ORM或参数化查询）
   - 文件上传类型和大小限制
   - 用户输入验证和过滤

3. **性能优化**
   - 数据库索引优化
   - 图片压缩上传
   - 列表分页加载
   - 接口响应缓存（如Banner）
   - 数据库连接池

4. **用户体验**
   - 加载状态提示
   - 错误提示友好化
   - 操作反馈及时
   - 网络错误重试机制

5. **部署考虑**
   - 使用 Docker Compose 统一管理所有服务
   - 后端服务部署（Node.js容器）
   - 数据库部署（MySQL容器，数据持久化）
   - phpMyAdmin部署（容器化，用于数据库管理）
   - 文件存储（腾讯云COS）
   - 域名和HTTPS配置
   - 小程序域名白名单配置
   - Docker 镜像构建和版本管理

## 开发时间估算

### 后端开发
- 项目初始化和环境搭建（包含 Docker Compose 配置）：1.5天
- 数据库设计和创建：0.5天
- 认证模块：1.5天
- 业务接口开发：2.5天
- 图片上传功能（COS集成）：1天
- 测试和优化：1天

**后端总计：约8天**

### 前端开发
- 项目初始化和配置：0.5天
- 用户认证：1天
- 首页开发：1.5天
- 课程详情页：1.5天
- 记录详情页：1天
- 我的页面：0.5天
- 联调和优化：1天

**前端总计：约7天**

### 整体项目
- 前后端联调：1天
- 整体测试和优化：1天

**项目总计：约17天（约3-4周）**

